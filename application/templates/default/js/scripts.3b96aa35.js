"use strict";angular.module("muzloTemplateApp",["ngAnimate","ngAria","ngCookies","ngMessages","ngResource","ngRoute","ngSanitize","ngTouch"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/player.html",controller:"PlayerCtrl",controllerAs:"player"}).otherwise({redirectTo:"/"})}]),angular.module("muzloTemplateApp").factory("AudioService",function(){var a={swf_path:"bower_components/audio5/swf/audio5js.swf",throw_errors:!0,format_time:!0},b=new Audio5js(a);return b}).factory("AudioServiceAd",function(){var a={swf_path:"bower_components/audio5/swf/audio5js.swf",throw_errors:!0,format_time:!0},b=new Audio5js(a);return b}).controller("PlayerCtrl",["$scope","$http","AudioService","AudioServiceAd",function(a,b,c,d){this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"],b.get(window.patternUrl).then(function(e){function f(a,b){var c=new FileReader;c.onload=b,c.readAsDataURL(a)}a.blobs=[],a.playerAd=d,a.player=c,a.timeoutAd=0,a.pattern=e.data[0],a.patterns_dirs=a.pattern.patterns_dirs,a.patterns_dir=a.patterns_dirs[Object.keys(a.patterns_dirs)[0]],console.log("url advert "+window.advertUrl),console.log("length pattern dirs "+Object.keys(a.patterns_dirs).length),Object.keys(a.patterns_dirs).length>0&&b.get(window.advertUrl).then(function(b){a.ad=b.data[0].files,a.numberTrackAd=0,a.adInterval=60*b.data[0].rhythm*1e3,a.timeoutAd=a.adInterval,$.each(a.ad,function(b,c){var d=new XMLHttpRequest;d.addEventListener("load",function(){200==d.status&&(a.blobs[c.file_name]=d.response)}),d.open("GET",c.file_name),d.responseType="blob",d.send(null)})}),$.each(a.patterns_dir.music_files,function(b,c){var d=new XMLHttpRequest;d.addEventListener("load",function(){200==d.status&&(a.blobs[c.file_name]=d.response)}),d.open("GET",c.file_name),d.responseType="blob",d.send(null)}),a.numberTrack=0,a.checkPlaylistTime=function(a){return!1},a.findPlaylistTime=function(){return!1},a.reset=function(){var b=new Date(1e3*a.patterns_dir.time_start),c=new Date(1e3*a.patterns_dir.time_end),d=!1;b=b.getHours()+":"+b.getMinutes(),c=c.getHours()+":"+c.getMinutes(),a.timeoutAd=a.adInterval,a.isReady()?d=!0:a.searchPlaylist()&&(d=!0),d?(a.numberTrack=0,a.shuffle(),a.timeoutAd=a.adInterval,g(a.patterns_dir)):a.resetAnimation()},a.stop=function(){a.player.audio.pause()};var g=function(b){a.blobs[b.music_files[a.numberTrack].file_name]instanceof Blob?(console.log("blob"),f(a.blobs[b.music_files[a.numberTrack].file_name],function(b){a.player.load(b.target.result),a.player.audio.play()})):(console.log("no blob"),a.player.load(b.music_files[a.numberTrack].file_name),a.player.audio.play()),a.player.on("canplay",function(){a.resetAnimation()}),a.debug=function(b,c){var d=new Date(1e3*a.patterns_dir.time_start),e=new Date(1e3*a.patterns_dir.time_end);d=d.getHours()+":"+d.getMinutes(),e=e.getHours()+":"+e.getMinutes()}};a.player.on("timeupdate",function(b,c){a.isReady()||(a.player.audio.pause(),a.reset()),a.debug(b,c),a.timeoutAd-=250,console.log(a.timeoutAd),a.timeoutAd<=0&&(a.stop(),$(".ad").show(),$(".player-buttons").hide(),f(a.blobs[a.ad[a.numberTrackAd].file_name],function(b){a.playerAd.load(b.target.result),a.playerAd.audio.play()}))}),a.playerAd.on("ended",function(){a.numberTrackAd++,a.numberTrackAd>=a.ad.length&&(a.numberTrackAd=0),a.timeoutAd=a.adInterval,setTimeout(function(){a.play(),$(".ad").hide(),$(".player-buttons").show()},1e3)}),a.player.on("ended",function(){setTimeout(function(){a.playNext()},1e3)}),a.playNext=function(){a.numberTrack++,a.numberTrack>=a.patterns_dir.music_files.length&&(a.numberTrack=0),g(a.patterns_dir)},a.shuffle=function(){var b=function(a){for(var b,c,d=a.length;d;)c=Math.floor(Math.random()*d--),b=a[d],a[d]=a[c],a[c]=b;return a};a.patterns_dir.music_files=b(a.patterns_dir.music_files)},a.checkTimeInterval=function(a,b){if(b>a){if(moment(1e3*a).format("HH:mm:ss")<=moment().format("HH:mm:ss")&&moment(1e3*b).format("HH:mm:ss")>=moment().format("HH:mm:ss"))return!0}else if(moment(1e3*a).format("HH:mm:ss")<=moment().format("HH:mm:ss")||moment(1e3*b).format("HH:mm:ss")>=moment().format("HH:mm:ss"))return!0;return!1},a.isReady=function(){return a.checkTimeInterval(a.patterns_dir.time_start,a.patterns_dir.time_end)?!0:!1},a.searchPlaylist=function(){var b=!1;return $.each(a.patterns_dirs,function(c,d){return a.checkTimeInterval(d.time_start,d.time_end)?(a.patterns_dir=d,b=!0,!0):void 0}),b},a.play=function(){a.player.position&&!a.player.playing&&a.isReady()?a.player.audio.play():a.player.position||a.reset(),setTimeout(function(){a.resetAnimation()},1e3)},a.resetAnimation=function(){setTimeout(function(){$(".player-buttons .bg").removeClass("animated")},1e3)},$(".player-buttons li.btn-play").click(function(){$(this).find("span.bg").addClass("bounce animated forever")})})}]),angular.module("muzloTemplateApp").run(["$templateCache",function(a){a.put("views/player.html",'<div class="debug"> </div> <div class="wrap-player"> <div class="player"> <div class="ad"> <div class="table"> <div class="table-cell"> <p>Реклама</p> </div> </div> </div> <div class="player-buttons"> <ul> <li class="btn-play" ng-click="play()"> <div class="wrap"> <span class="bg"></span> <span>PLAY</span> </div> </li> <li class="btn-stop" ng-click="stop()"> <div class="wrap"> <span class="bg"></span> <span>STOP</span> </div> </li> <li class="btn-reset" ng-click="reset()"> <div class="wrap"> <span class="bg"></span> <span>RESET</span> </div> </li> </ul> </div> </div> </div>')}]);